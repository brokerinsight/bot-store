<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deriv Bot Store</title>
  <!-- Tailwind CSS CDN with Dark Mode Configuration -->
  <script>
    tailwind.config = {
      darkMode: 'class' // Enable dark mode using the 'dark' class
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Ensure the body takes up the full viewport height and pushes the footer to the bottom */
    html, body {
      height: 100%;
      margin: 0;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex flex-col min-h-screen">
  <!-- Navbar -->
  <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <a href="/" class="text-xl font-bold text-gray-800 dark:text-gray-100">Deriv Bot Store</a>
          <div class="ml-6 flex space-x-4 sm:space-x-8">
            <a href="/" class="text-gray-500 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 inline-flex items-center px-1 pt-1 text-sm font-medium border-b-2 border-green-500">Home</a>
            <!-- Categories dynamically populated -->
          </div>
        </div>
        <div class="flex items-center">
          <!-- Dark/Light Mode Toggle Button -->
          <button id="theme-toggle" class="text-gray-500 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100">
            <svg id="theme-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <!-- Sun icon (shown in dark mode) -->
              <path id="sun-icon" class="hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
              <!-- Moon icon (shown in light mode) -->
              <path id="moon-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Urgent Message -->
  <div id="urgent-message" class="hidden bg-red-500 text-white text-center py-2">
    <p id="urgent-text"></p>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 flex-grow">
    <!-- Search Bar -->
    <div class="mb-8">
      <div class="relative">
        <input type="text" id="search" placeholder="Search bots by name or desc..." class="w-full px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500">
        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </div>

    <!-- Heading -->
    <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100 text-center mb-8">Explore Our Bots</h2>

    <!-- Products -->
    <div id="products" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Products dynamically populated -->
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white dark:bg-gray-800 shadow-inner mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex flex-col sm:flex-row justify-between items-center">
        <p id="copyright-text" class="text-gray-500 dark:text-gray-400 text-sm"></p>
        <div class="mt-4 sm:mt-0 flex space-x-4">
          <a id="support-email" href="#" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-sm">Support</a>
          <!-- Socials dynamically populated -->
        </div>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script>
    // GitHub configuration
    let GITHUB_TOKEN = null;
    const REPO_OWNER = "brokerinsight";
    const REPO_NAME = "bot-store";
    const FILE_PATH = "data.json";
    const BRANCH = "main";

    // Fetch the GitHub token from the API endpoint
    async function fetchGitHubToken() {
      try {
        const response = await fetch("/api/get-token");
        const data = await response.json();
        if (data.token) {
          GITHUB_TOKEN = data.token;
        } else {
          throw new Error("GitHub token not found");
        }
      } catch (error) {
        console.error("Error fetching GitHub token:", error);
        alert("Failed to load GitHub token. Please check the console for details.");
      }
    }

    // Data variables
    let products = [];
    let categories = [];
    let settings = {};
    let lastSha = null; // To track the SHA of data.json for polling

    // Fetch data from GitHub with cache-busting
    async function fetchData() {
      if (!GITHUB_TOKEN) {
        await fetchGitHubToken();
      }
      try {
        const timestamp = new Date().getTime();
        const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}?ref=${BRANCH}&t=${timestamp}`;
        
        const response = await fetch(url, {
          headers: {
            Authorization: `token ${GITHUB_TOKEN}`,
            Accept: "application/vnd.github.v3+json",
            "Cache-Control": "no-cache, no-store, must-revalidate",
            Pragma: "no-cache",
            Expires: "0"
          },
          cache: "no-store"
        });
        
        if (!response.ok) {
          throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        
        // Check if the SHA has changed (i.e., data.json was updated)
        if (lastSha && lastSha === data.sha) {
          return false; // No changes, skip rendering
        }
        
        lastSha = data.sha; // Update the last known SHA
        const content = JSON.parse(atob(data.content));
        products = content.products || [];
        categories = content.categories || ["Digit Bots", "Over/Under", "Rise/Fall"];
        settings = content.settings || {
          supportEmail: "support@derivbotstore.com",
          copyrightText: "Â© 2025 Deriv Bot Store. All rights reserved.",
          logoUrl: "",
          socials: { tiktok: "", whatsapp: "", call: "", instagram: "", x: "", facebook: "", youtube: "" },
          urgentMessage: { enabled: false, text: "" },
          paymentGateway: { name: "", url: "https://kaylie-payment-site.vercel.app/" }
        };
        return true; // Data changed, re-render
      } catch (error) {
        console.error("Error fetching data:", error);
        return false; // Failed to fetch, don't re-render
      }
    }

    // Render categories in navbar
    function renderCategories() {
      const nav = document.querySelector("nav .flex.space-x-4");
      const categoryLinks = categories.map(cat => `
        <a href="#${cat.toLowerCase().replace(/\s+/g, '-')}" class="text-gray-500 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 inline-flex items-center px-1 pt-1 text-sm font-medium">${cat}</a>
      `).join("");
      nav.innerHTML = `<a href="/" class="text-gray-500 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 inline-flex items-center px-1 pt-1 text-sm font-medium border-b-2 border-green-500">Home</a>` + categoryLinks;
    }

    // Render products
    function renderProducts() {
      const productsDiv = document.getElementById("products");
      productsDiv.innerHTML = products.filter(p => !p.isArchived).map(product => `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
          <img src="${product.img}" alt="${product.name}" class="w-full h-48 object-cover rounded-md mb-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">${product.name}</h3>
          <p class="text-gray-600 dark:text-gray-400 text-sm mt-1">${product.desc}</p>
          <p class="text-gray-900 dark:text-gray-100 font-bold mt-2">$${product.price}</p>
          ${product.isNew ? '<span class="inline-block bg-green-500 text-white text-xs px-2 py-1 rounded mt-2">New</span>' : ''}
          ${product.embed ? `
            <div class="mt-4">
              <iframe class="w-full h-48" src="${product.embed}" frameborder="0" allowfullscreen></iframe>
            </div>
          ` : ''}
          <a href="${settings.paymentGateway.url}?item=${product.item}&price=${product.price}" target="_blank" class="block mt-4 bg-green-600 text-white text-center py-2 rounded-md hover:bg-green-700">Buy Now</a>
        </div>
      `).join("");
    }

    // Render footer
    function renderFooter() {
      document.getElementById("support-email").href = `mailto:${settings.supportEmail}`;
      document.getElementById("support-email").textContent = settings.supportEmail;
      document.getElementById("copyright-text").textContent = settings.copyrightText;

      const socialsDiv = document.querySelector("footer .flex.space-x-4");
      const socials = settings.socials;
      const socialLinks = [];
      if (socials.tiktok) socialLinks.push(`<a href="${socials.tiktok}" target="_blank" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-sm">TikTok</a>`);
      if (socials.whatsapp) socialLinks.push(`<a href="${socials.whatsapp}" target="_blank" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-sm">WhatsApp</a>`);
      if (socials.call) socialLinks.push(`<a href="${socials.call}" target="_blank" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-sm">Call</a>`);
      if (socials.instagram) socialLinks.push(`<a href="${socials.instagram}" target="_blank" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-sm">Instagram</a>`);
      if (socials.x) socialLinks.push(`<a href="${socials.x}" target="_blank" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-sm">X</a>`);
      if (socials.facebook) socialLinks.push(`<a href="${socials.facebook}" target="_blank" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-sm">Facebook</a>`);
      if (socials.youtube) socialLinks.push(`<a href="${socials.youtube}" target="_blank" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-sm">YouTube</a>`);
      socialsDiv.innerHTML += socialLinks.join("");
    }

    // Render urgent message
    function renderUrgentMessage() {
      const urgentDiv = document.getElementById("urgent-message");
      const urgentText = document.getElementById("urgent-text");
      if (settings.urgentMessage.enabled) {
        urgentText.textContent = settings.urgentMessage.text;
        urgentDiv.classList.remove("hidden");
      }
    }

    // Poll for updates every 5 seconds
    async function startPolling() {
      const interval = setInterval(async () => {
        const dataChanged = await fetchData();
        if (dataChanged) {
          renderCategories();
          renderProducts();
          renderFooter();
          renderUrgentMessage();
        }
      }, 5000); // Poll every 5 seconds
    }

    // Dark/Light Mode Toggle
    const themeToggle = document.getElementById("theme-toggle");
    const themeIcon = document.getElementById("theme-icon");
    const sunIcon = document.getElementById("sun-icon");
    const moonIcon = document.getElementById("moon-icon");

    // Load the saved theme from localStorage
    const savedTheme = localStorage.getItem("theme") || "light";
    if (savedTheme === "dark") {
      document.documentElement.classList.add("dark");
      sunIcon.classList.remove("hidden");
      moonIcon.classList.add("hidden");
    } else {
      document.documentElement.classList.remove("dark");
      sunIcon.classList.add("hidden");
      moonIcon.classList.remove("hidden");
    }

    // Toggle theme on button click
    themeToggle.addEventListener("click", () => {
      if (document.documentElement.classList.contains("dark")) {
        document.documentElement.classList.remove("dark");
        localStorage.setItem("theme", "light");
        sunIcon.classList.add("hidden");
        moonIcon.classList.remove("hidden");
      } else {
        document.documentElement.classList.add("dark");
        localStorage.setItem("theme", "dark");
        sunIcon.classList.remove("hidden");
        moonIcon.classList.add("hidden");
      }
    });

    // Initialize
    async function initialize() {
      await fetchData();
      renderCategories();
      renderProducts();
      renderFooter();
      renderUrgentMessage();
      startPolling(); // Start polling for updates
    }

    // Run initialization
    initialize();
  </script>
</body>
</html>
